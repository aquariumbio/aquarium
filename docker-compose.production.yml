version: "3.5"
services:
  backend:
    build:
      context: ./backend
      target: aquarium-backend
    image: aquarium-backend:${AQUARIUM_VERSION:-edge}
    depends_on:
      - db
    env_file: 
      - .env_files/production/backend
      - .env_files/development/timezone
    networks:
      - aquarium_net

  frontend:
    build:
      context: ./frontend
      target: aquarium-frontend
    image: aquarium-frontend:${AQUARIUM_VERSION:-edge}
    depends_on:
      - backend
    networks:
      - aquarium_net

  db:
    env_file: 
      - .env_files/production/db
      - .env_files/production/timezone

  db-migrator:
    image: aquarium-backend:${AQUARIUM_VERSION:-edge}
    command: [ "./wait-for.sh", "--timeout=300", "db:3306", "--", "bin/rails", "db:migrate" ]
    env_file:
      - .env_files/production/backend
      - .env_files/production/timezone
    depends_on:
      - db
    networks:
        - aquarium_net

  web:
    build:
      context: ./nginx
      target: aquarium-nginx
    image: aquarium-nginx:${AQUARIUM_VERSION:-edge}
    ports:
      - "${APP_PUBLIC_PORT:-80}:80"
    networks:
      - aquarium_net
    depends_on:
      - backend
      - frontend
